#!/usr/bin/env python3
"""
paco-list - List projects or tasks
Usage: 
  paco-list projects
  paco-list tasks <project>
"""

import sys
import argparse
from paco_lib import list_projects, load_tasks, init_paco_dirs


def main():
    parser = argparse.ArgumentParser(
        description="List PACO projects or tasks"
    )
    
    subparsers = parser.add_subparsers(dest="command", help="What to list")
    
    # List projects
    subparsers.add_parser("projects", help="List all projects")
    
    # List tasks
    tasks_parser = subparsers.add_parser("tasks", help="List tasks in a project")
    tasks_parser.add_argument("project", help="Project name")
    tasks_parser.add_argument(
        "--all",
        action="store_true",
        help="Show all tasks (including completed)"
    )
    
    args = parser.parse_args()
    
    # Initialize PACO dirs
    init_paco_dirs()
    
    if args.command == "projects":
        projects = list_projects()
        if not projects:
            print("No projects yet. Create one with: paco-add-task <project> <task>")
        else:
            print(f"üìÅ Projects ({len(projects)}):")
            for project in sorted(projects):
                print(f"  ‚Ä¢ {project}")
    
    elif args.command == "tasks":
        status_filter = None if args.all else "active"
        tasks = load_tasks(args.project, status_filter=status_filter)
        
        if not tasks:
            status_msg = "tasks" if args.all else "active tasks"
            print(f"No {status_msg} in '{args.project}'")
        else:
            status_msg = "All Tasks" if args.all else "Active Tasks"
            print(f"üìã {args.project} - {status_msg} ({len(tasks)}):\n")
            
            # Group by priority
            high = [t for t in tasks if t.get("priority") == "high"]
            medium = [t for t in tasks if t.get("priority") == "medium"]
            low = [t for t in tasks if t.get("priority") == "low"]
            
            for priority_group, priority_name in [(high, "HIGH"), (medium, "MEDIUM"), (low, "LOW")]:
                if priority_group:
                    print(f"  {priority_name}:")
                    for task in priority_group:
                        status_icon = "‚úì" if task.get("status") == "completed" else "‚óã"
                        tags_str = f" [{', '.join(task.get('tags', []))}]" if task.get('tags') else ""
                        print(f"    {status_icon} [ID:{task['id']}] {task['title']}{tags_str}")
                    print()
    
    else:
        parser.print_help()


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nCancelled.")
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)
