#!/usr/bin/env python3
"""
paco-summarize-day - Generate summary of today's daily notes
Usage: paco-summarize-day [date]
"""

import sys
import argparse
from datetime import datetime
from paco_lib import (
    init_paco_dirs, 
    get_daily_note,
    call_ollama,
    DAILY_SUMMARIES_DIR
)


def main():
    parser = argparse.ArgumentParser(
        description="Generate summary of daily notes using LLM"
    )
    parser.add_argument(
        "date",
        nargs="?",
        help="Date to summarize (YYYY-MM-DD), defaults to today"
    )
    parser.add_argument(
        "--model",
        default="llama3.2",
        help="Ollama model to use (default: llama3.2)"
    )
    
    args = parser.parse_args()
    
    # Initialize PACO dirs
    init_paco_dirs()
    
    # Get date
    if args.date:
        date_str = args.date
    else:
        date_str = datetime.now().strftime("%Y-%m-%d")
    
    # Read daily note
    daily_content = get_daily_note(date_str)
    
    if not daily_content:
        print(f"No daily note found for {date_str}")
        sys.exit(1)
    
    print(f"üìù Summarizing daily note for {date_str}...")
    
    # Build prompt
    system_prompt = """You are PACO, a personal productivity assistant.
Create a brief daily summary (5-15 sentences) that captures:
1. What the person worked on today
2. Key insights or learnings
3. Important things to remember for tomorrow
4. Any decisions made

Be concise and focus on actionable information."""
    
    user_prompt = f"""Based on today's notes, create a brief summary:

{daily_content}

Generate a daily summary:"""
    
    # Call LLM
    print("üí≠ Generating summary...")
    summary = call_ollama(user_prompt, model=args.model, system_prompt=system_prompt)
    
    # Write summary
    DAILY_SUMMARIES_DIR.mkdir(exist_ok=True)
    summary_file = DAILY_SUMMARIES_DIR / f"{date_str}.summary.md"
    
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
    summary_content = f"""# Daily Summary - {date_str}

*Generated: {timestamp}*

{summary}
"""
    
    summary_file.write_text(summary_content)
    print(f"‚úì Summary saved: {summary_file}")
    print("\n‚ú® Done!")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nCancelled.")
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)
